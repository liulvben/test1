<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photon Cloud简单测试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; font-weight: bold; }
        .online { background-color: #d4edda; color: #155724; }
        .offline { background-color: #f8d7da; color: #721c24; }
        .connecting { background-color: #fff3cd; color: #856404; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .connect { background-color: #007bff; color: white; }
        .disconnect { background-color: #dc3545; color: white; }
    </style>
</head>
<body>
    <h1>Photon Cloud简单连接测试</h1>
    <div id="status" class="status offline">离线</div>
    <button class="connect" onclick="connectPhoton()">连接Photon Cloud</button>
    <button class="disconnect" onclick="disconnectPhoton()">断开连接</button>
    <div id="log" style="margin-top: 20px; height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px;"></div>

    <script>
        let photonClient = null;
        let isConnected = false;

        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${timestamp}] ${message}<br>`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function updateStatus(status) {
            const statusElement = document.getElementById('status');
            statusElement.className = 'status ' + status;
            statusElement.textContent = status === 'online' ? '在线' : status === 'connecting' ? '连接中' : '离线';
        }

        // 动态加载Photon SDK
        function loadPhotonSDK() {
            return new Promise((resolve, reject) => {
                if (typeof loadBalancingClient !== 'undefined') {
                    log('Photon SDK已加载');
                    resolve();
                    return;
                }

                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/@photonengine/realtime@5.0.4/dist/realtime.min.js';
                
                script.onload = () => {
                    log('Photon SDK加载成功');
                    setTimeout(() => {
                        if (typeof loadBalancingClient !== 'undefined') {
                            resolve();
                        } else {
                            reject('SDK加载但未定义loadBalancingClient');
                        }
                    }, 1000);
                };
                
                script.onerror = () => {
                    log('Photon SDK加载失败，尝试备用链接');
                    // 尝试备用CDN
                    const fallbackScript = document.createElement('script');
                    fallbackScript.src = 'https://unpkg.com/@photonengine/realtime@5.0.4/dist/realtime.min.js';
                    
                    fallbackScript.onload = () => {
                        log('备用Photon SDK加载成功');
                        setTimeout(() => resolve(), 1000);
                    };
                    
                    fallbackScript.onerror = () => {
                        reject('所有CDN链接都失败');
                    };
                    
                    document.head.appendChild(fallbackScript);
                };
                
                document.head.appendChild(script);
            });
        }

        async function connectPhoton() {
            if (isConnected) {
                log('已经连接到Photon Cloud');
                return;
            }

            try {
                updateStatus('connecting');
                log('开始加载Photon SDK...');
                
                await loadPhotonSDK();
                
                log('开始连接到Photon Cloud...');
                
                // 创建客户端
                photonClient = new loadBalancingClient({
                    appId: '84e83fae-288e-4cf8-87e8-da69c2639380',
                    appVersion: '1.0',
                    useWSS: true
                });

                // 设置事件监听
                photonClient.on('connectionStateChange', (state) => {
                    log('连接状态: ' + state);
                    
                    if (state === 'Joined') {
                        isConnected = true;
                        updateStatus('online');
                        log('✓ 成功连接到Photon Cloud!');
                        log('玩家ID: ' + photonClient.userId);
                        if (photonClient.currentRoom) {
                            log('房间: ' + photonClient.currentRoom.name);
                            log('在线玩家: ' + photonClient.currentRoom.actorCount);
                        }
                    } else if (state === 'Disconnected') {
                        isConnected = false;
                        updateStatus('offline');
                        log('与Photon Cloud断开连接');
                    }
                });

                photonClient.on('actorJoined', (actor) => {
                    log('玩家加入: ' + actor.actorNr);
                });

                photonClient.on('actorLeft', (actor) => {
                    log('玩家离开: ' + actor.actorNr);
                });

                photonClient.on('error', (error) => {
                    log('错误: ' + error);
                    updateStatus('offline');
                });

                // 连接并加入房间
                photonClient.connectAndJoinRandomRoom({
                    maxPlayers: 4
                });

            } catch (error) {
                log('连接失败: ' + error);
                updateStatus('offline');
                log('请检查: 1) 网络连接 2) App ID是否正确 3) 浏览器控制台错误信息');
            }
        }

        function disconnectPhoton() {
            if (photonClient) {
                photonClient.disconnect();
                photonClient = null;
                isConnected = false;
                updateStatus('offline');
                log('已断开连接');
            }
        }

        // 页面加载时显示基本信息
        window.onload = function() {
            log('页面加载完成');
            log('点击"连接Photon Cloud"按钮开始测试');
            log('如果连接失败，请按F12查看浏览器控制台错误信息');
        };
    </script>
</body>
</html>