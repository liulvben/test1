<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photon Cloudè¿œç¨‹è”æœºæµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; font-weight: bold; }
        .online { background-color: #d4edda; color: #155724; }
        .offline { background-color: #f8d7da; color: #721c24; }
        .connecting { background-color: #fff3cd; color: #856404; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .connect { background-color: #007bff; color: white; }
        .disconnect { background-color: #dc3545; color: white; }
        .info { background: #e9ecef; padding: 10px; border-radius: 4px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ® Photon Cloudè¿œç¨‹è”æœºæµ‹è¯•</h1>
        <div class="info">
            <strong>æµ‹è¯•ç›®æ ‡ï¼š</strong>å®ç°çœŸæ­£çš„è¿œç¨‹å¤šäººè”æœºæ¸¸æˆ<br>
            <strong>æŠ€æœ¯æ ˆï¼š</strong>Photon Cloud + GitHub Pages<br>
            <strong>App IDï¼š</strong>84e83fae-288e-4cf8-87e8-da69c2639380
        </div>
        
        <div id="status" class="status offline">ğŸ”´ ç¦»çº¿</div>
        <div>ğŸ‘¥ åœ¨çº¿ç©å®¶: <span id="playerCount">0</span></div>
        <div>ğŸ  æˆ¿é—´: <span id="roomInfo">æœªåŠ å…¥</span></div>
        
        <button class="connect" onclick="connectPhoton()">ğŸš€ è¿æ¥Photon Cloud</button>
        <button class="disconnect" onclick="disconnectPhoton()">âŒ æ–­å¼€è¿æ¥</button>
        <button onclick="sendTestEvent()">ğŸ“¤ å‘é€æµ‹è¯•äº‹ä»¶</button>
        
        <div id="log" style="margin-top: 20px; height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background: #f8f9fa;"></div>
    </div>

    <!-- Photon Cloud SDK - ä½¿ç”¨å¤šä¸ªCDNç¡®ä¿åŠ è½½æˆåŠŸ -->
    <script src="https://cdn.jsdelivr.net/npm/@photonengine/realtime@5.0.4/dist/realtime.min.js"></script>
    <script>
        // å¤‡ç”¨CDNåŠ è½½
        setTimeout(function() {
            if (typeof loadBalancingClient === 'undefined') {
                console.log('Primary CDN failed, loading backup...');
                var backupScript = document.createElement('script');
                backupScript.src = 'https://unpkg.com/@photonengine/realtime@5.0.4/dist/realtime.min.js';
                document.head.appendChild(backupScript);
            }
        }, 3000);
    </script>
    
    <script>
        let photonClient = null;
        let isConnected = false;
        let playerId = null;

        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `<span style="color: #666;">[${timestamp}]</span> ${message}<br>`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function updateStatus(status) {
            const statusElement = document.getElementById('status');
            statusElement.className = 'status ' + status;
            statusElement.innerHTML = status === 'online' ? 'ğŸŸ¢ åœ¨çº¿' : 
                                   status === 'connecting' ? 'ğŸŸ¡ è¿æ¥ä¸­' : 'ğŸ”´ ç¦»çº¿';
        }

        function updatePlayerCount(count) {
            document.getElementById('playerCount').textContent = count;
        }

        function updateRoomInfo(info) {
            document.getElementById('roomInfo').textContent = info;
        }

        // åŠ¨æ€åŠ è½½Photon SDK
        function loadPhotonSDK() {
            return new Promise((resolve, reject) => {
                // æ£€æŸ¥æ˜¯å¦å·²åŠ è½½
                if (typeof loadBalancingClient !== 'undefined') {
                    log('âœ… Photon SDKå·²åŠ è½½');
                    resolve();
                    return;
                }

                log('ğŸ“¥ åŠ è½½Photon SDK...');
                
                // å°è¯•å¤šä¸ªCDN
                const cdns = [
                    'https://cdn.jsdelivr.net/npm/@photonengine/realtime@5.0.4/dist/realtime.min.js',
                    'https://unpkg.com/@photonengine/realtime@5.0.4/dist/realtime.min.js',
                    'https://cdn.photonengine.com/realtime/5.0.4/realtime.min.js'
                ];

                let currentCdn = 0;

                function tryNextCDN() {
                    if (currentCdn >= cdns.length) {
                        reject('æ‰€æœ‰CDNéƒ½åŠ è½½å¤±è´¥');
                        return;
                    }

                    const script = document.createElement('script');
                    script.src = cdns[currentCdn];
                    
                    script.onload = () => {
                        log(`âœ… CDN ${currentCdn + 1} åŠ è½½æˆåŠŸ`);
                        setTimeout(() => {
                            if (typeof loadBalancingClient !== 'undefined') {
                                resolve();
                            } else {
                                log('âŒ SDKåŠ è½½ä½†æœªå®šä¹‰ï¼Œå°è¯•ä¸‹ä¸€ä¸ªCDN');
                                currentCdn++;
                                tryNextCDN();
                            }
                        }, 1000);
                    };
                    
                    script.onerror = () => {
                        log(`âŒ CDN ${currentCdn + 1} åŠ è½½å¤±è´¥`);
                        currentCdn++;
                        tryNextCDN();
                    };
                    
                    document.head.appendChild(script);
                }

                tryNextCDN();
            });
        }

        async function connectPhoton() {
            if (isConnected) {
                log('âš ï¸ å·²ç»è¿æ¥åˆ°Photon Cloud');
                return;
            }

            try {
                updateStatus('connecting');
                log('ğŸš€ å¼€å§‹è¿æ¥Photon Cloud...');
                
                // åŠ è½½SDK
                await loadPhotonSDK();
                
                log('ğŸ”— åˆ›å»ºPhotonå®¢æˆ·ç«¯...');
                
                // åˆ›å»ºå®¢æˆ·ç«¯
                photonClient = new loadBalancingClient({
                    appId: '84e83fae-288e-4cf8-87e8-da69c2639380',
                    appVersion: '1.0',
                    useWSS: true
                });

                // è®¾ç½®äº‹ä»¶ç›‘å¬
                setupPhotonEvents();

                // è¿æ¥å¹¶åŠ å…¥æˆ¿é—´
                log('ğŸ¯ è¿æ¥å¹¶åŠ å…¥éšæœºæˆ¿é—´...');
                photonClient.connectAndJoinRandomRoom({
                    maxPlayers: 4
                });

            } catch (error) {
                log(`âŒ è¿æ¥å¤±è´¥: ${error}`);
                updateStatus('offline');
                log('ğŸ’¡ è§£å†³æ–¹æ¡ˆ:');
                log('1. æ£€æŸ¥ç½‘ç»œè¿æ¥');
                log('2. ç¡®è®¤App IDæ­£ç¡®');
                log('3. æŒ‰F12æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯');
            }
        }

        function setupPhotonEvents() {
            photonClient.on('connectionStateChange', (state) => {
                log(`ğŸ”Œ è¿æ¥çŠ¶æ€: ${state}`);
                
                if (state === 'Joined') {
                    isConnected = true;
                    updateStatus('online');
                    playerId = photonClient.userId;
                    log('ğŸ‰ æˆåŠŸè¿æ¥åˆ°Photon Cloud!');
                    log(`ğŸ‘¤ ç©å®¶ID: ${playerId}`);
                    
                    if (photonClient.currentRoom) {
                        const room = photonClient.currentRoom;
                        updateRoomInfo(room.name);
                        updatePlayerCount(room.actorCount);
                        log(`ğŸ  æˆ¿é—´: ${room.name}, ç©å®¶æ•°: ${room.actorCount}`);
                    }
                } else if (state === 'Disconnected') {
                    isConnected = false;
                    updateStatus('offline');
                    log('ğŸ”Œ ä¸Photon Cloudæ–­å¼€è¿æ¥');
                }
            });

            photonClient.on('actorJoined', (actor) => {
                log(`ğŸ‘¥ ç©å®¶åŠ å…¥: ${actor.actorNr}`);
                if (photonClient.currentRoom) {
                    updatePlayerCount(photonClient.currentRoom.actorCount);
                }
            });

            photonClient.on('actorLeft', (actor) => {
                log(`ğŸ‘‹ ç©å®¶ç¦»å¼€: ${actor.actorNr}`);
                if (photonClient.currentRoom) {
                    updatePlayerCount(photonClient.currentRoom.actorCount);
                }
            });

            photonClient.on('customEvent', (eventData) => {
                log(`ğŸ“¨ æ”¶åˆ°è‡ªå®šä¹‰äº‹ä»¶: ${JSON.stringify(eventData)}`);
            });

            photonClient.on('error', (error) => {
                log(`âŒ é”™è¯¯: ${error}`);
                updateStatus('offline');
            });
        }

        function sendTestEvent() {
            if (!isConnected || !photonClient) {
                log('âš ï¸ è¯·å…ˆè¿æ¥åˆ°Photon Cloud');
                return;
            }

            const testEvent = {
                type: 'test_message',
                playerId: playerId,
                message: 'è¿œç¨‹è”æœºæµ‹è¯•æ¶ˆæ¯',
                timestamp: Date.now()
            };

            photonClient.sendEvent(testEvent);
            log('ğŸ“¤ å‘é€æµ‹è¯•äº‹ä»¶');
        }

        function disconnectPhoton() {
            if (photonClient) {
                photonClient.disconnect();
                photonClient = null;
                isConnected = false;
                updateStatus('offline');
                updatePlayerCount(0);
                updateRoomInfo('æœªåŠ å…¥');
                log('ğŸ”Œ å·²æ–­å¼€è¿æ¥');
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯
        window.onload = function() {
            log('ğŸŒ è¿œç¨‹è”æœºæµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
            log('ğŸ’¡ ç‚¹å‡»"è¿æ¥Photon Cloud"å¼€å§‹æµ‹è¯•');
            log('ğŸ¯ ç›®æ ‡ï¼šå®ç°çœŸæ­£çš„è¿œç¨‹å¤šäººæ¸¸æˆ');
            
            // è‡ªåŠ¨æ£€æŸ¥SDKåŠ è½½çŠ¶æ€
            setTimeout(() => {
                if (typeof loadBalancingClient !== 'undefined') {
                    log('âœ… Photon SDKå·²å°±ç»ª');
                } else {
                    log('âš ï¸ ç­‰å¾…Photon SDKåŠ è½½...');
                }
            }, 1000);
        };
    </script>
</body>
</html>